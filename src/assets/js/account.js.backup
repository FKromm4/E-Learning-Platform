/**
 * ACCOUNT.JS - Account Management Page Logic
 * Handles password changes and payment methods (cards wallet)
 */

document.addEventListener('DOMContentLoaded', function () {
    // Only run on account page
    if (document.body.dataset.page !== 'account') return;

    // Check authentication
    if (!authService.isAuthenticated()) {
        window.location.href = 'login.html';
        return;
    }

    // Initialize account page
    initAccountPage();
});

/**
 * Initialize the account page
 */
function initAccountPage() {
    loadUserEmail();
    initPasswordChangeForm();
    initPaymentMethods();
}

/**
 * Load and display user email
 */
function loadUserEmail() {
    const user = authService.getCurrentUser();
    const emailInput = document.getElementById('user-email');

    if (emailInput && user) {
        emailInput.value = user.email;
    }
}

/**
 * Initialize password change form
 */
function initPasswordChangeForm() {
    const form = document.getElementById('change-password-form');
    const newPasswordInput = document.getElementById('new-password');

    if (!form) return;

    // Setup password toggle buttons
    setupPasswordToggles();

    // Setup password strength indicator
    if (newPasswordInput) {
        newPasswordInput.addEventListener('input', function () {
            updatePasswordStrength(this.value, 'new-password-strength');
        });
    }

    // Handle form submission
    form.addEventListener('submit', function (e) {
        e.preventDefault();
        handlePasswordChange();
    });
}

/**
 * Setup password toggle functionality
 */
function setupPasswordToggles() {
    const toggleButtons = document.querySelectorAll('.password-toggle');

    toggleButtons.forEach(button => {
        button.addEventListener('click', function () {
            const targetId = this.getAttribute('data-target');
            const targetInput = document.getElementById(targetId);

            if (targetInput) {
                const isPassword = targetInput.type === 'password';
                targetInput.type = isPassword ? 'text' : 'password';
                this.textContent = isPassword ? 'ğŸ™ˆ' : 'ğŸ‘ï¸';
                this.setAttribute('aria-label', isPassword ? 'Î‘Ï€ÏŒÎºÏÏ…ÏˆÎ· ÎºÏ‰Î´Î¹ÎºÎ¿Ï' : 'Î•Î¼Ï†Î¬Î½Î¹ÏƒÎ· ÎºÏ‰Î´Î¹ÎºÎ¿Ï');
            }
        });
    });
}

/**
 * Update password strength indicator
 */
function updatePasswordStrength(password, containerId) {
    const container = document.getElementById(containerId);
    if (!container) return;

    const strengthBar = container.querySelector('.password-strength-fill');
    const strengthText = container.querySelector('.password-strength-text');

    if (!password) {
        container.style.display = 'none';
        return;
    }

    container.style.display = 'block';

    // Calculate strength
    let strength = 0;
    if (password.length >= 8) strength++;
    if (password.length >= 12) strength++;
    if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength++;
    if (/\d/.test(password)) strength++;
    if (/[^a-zA-Z0-9]/.test(password)) strength++;

    // Update UI
    strengthBar.className = 'password-strength-fill';
    strengthText.className = 'password-strength-text';

    if (strength <= 2) {
        strengthBar.classList.add('weak');
        strengthText.classList.add('weak');
        strengthText.textContent = 'Î‘Î´ÏÎ½Î±Î¼Î¿Ï‚ ÎºÏ‰Î´Î¹ÎºÏŒÏ‚';
    } else if (strength <= 4) {
        strengthBar.classList.add('medium');
        strengthText.classList.add('medium');
        strengthText.textContent = 'ÎœÎ­Ï„ÏÎ¹Î¿Ï‚ ÎºÏ‰Î´Î¹ÎºÏŒÏ‚';
    } else {
        strengthBar.classList.add('strong');
        strengthText.classList.add('strong');
        strengthText.textContent = 'Î™ÏƒÏ‡Ï…ÏÏŒÏ‚ ÎºÏ‰Î´Î¹ÎºÏŒÏ‚';
    }
}

/**
 * Handle password change submission
 */
function handlePasswordChange() {
    const currentPassword = document.getElementById('current-password').value;
    const newPassword = document.getElementById('new-password').value;
    const confirmPassword = document.getElementById('confirm-password').value;

    // Clear previous errors
    clearFormErrors('change-password-form');

    // Validation
    if (newPassword.length < 8) {
        showFieldError('new-password', 'ÎŸ ÎºÏ‰Î´Î¹ÎºÏŒÏ‚ Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± Î­Ï‡ÎµÎ¹ Ï„Î¿Ï…Î»Î¬Ï‡Î¹ÏƒÏ„Î¿Î½ 8 Ï‡Î±ÏÎ±ÎºÏ„Î®ÏÎµÏ‚');
        return;
    }

    if (newPassword !== confirmPassword) {
        showFieldError('confirm-password', 'ÎŸÎ¹ ÎºÏ‰Î´Î¹ÎºÎ¿Î¯ Î´ÎµÎ½ Ï„Î±Î¹ÏÎ¹Î¬Î¶Î¿Ï…Î½');
        return;
    }

    if (currentPassword === newPassword) {
        showFieldError('new-password', 'ÎŸ Î½Î­Î¿Ï‚ ÎºÏ‰Î´Î¹ÎºÏŒÏ‚ Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± ÎµÎ¯Î½Î±Î¹ Î´Î¹Î±Ï†Î¿ÏÎµÏ„Î¹ÎºÏŒÏ‚ Î±Ï€ÏŒ Ï„Î¿Î½ Ï„ÏÎ­Ï‡Î¿Î½Ï„Î±');
        return;
    }

    // TODO: In a real application, verify current password with backend
    // For now, we'll just simulate success

    // Simulate API call
    setTimeout(() => {
        showNotification('ÎŸ ÎºÏ‰Î´Î¹ÎºÏŒÏ‚ ÏƒÎ±Ï‚ Î¬Î»Î»Î±Î¾Îµ Î¼Îµ ÎµÏ€Î¹Ï„Ï…Ï‡Î¯Î±!', 'success');
        document.getElementById('change-password-form').reset();
        document.getElementById('new-password-strength').style.display = 'none';
    }, 500);
}

/**
 * Initialize payment methods section
 */
function initPaymentMethods() {
    loadSavedCards();
    initAddCardForm();
    setupCardEventListeners();
}

/**
 * Setup event listeners for payment cards (delegation)
 */
function setupCardEventListeners() {
    const container = document.getElementById('saved-cards-container');
    if (!container) return;

    container.addEventListener('click', function (e) {
        const removeBtn = e.target.closest('.remove-card-btn');
        const defaultBtn = e.target.closest('.set-default-btn');

        if (removeBtn) {
            e.preventDefault();
            e.stopPropagation();
            const cardId = removeBtn.getAttribute('data-card-id');
            removeCard(cardId);
        } else if (defaultBtn) {
            e.preventDefault();
            e.stopPropagation();
            const cardId = defaultBtn.getAttribute('data-card-id');
            setDefaultCard(cardId);
        }
    });
}

/**
 * Load saved payment cards
 */
function loadSavedCards() {
    const container = document.getElementById('saved-cards-container');
    if (!container) return;

    // Get saved cards from localStorage
    const savedCards = getStoredCards();

    if (savedCards.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: var(--space-8); color: var(--color-text-muted);">
                <p style="font-size: var(--font-size-lg); margin-bottom: var(--space-2);">ğŸ’³</p>
                <p>Î”ÎµÎ½ Î­Ï‡ÎµÏ„Îµ Ï€ÏÎ¿ÏƒÎ¸Î­ÏƒÎµÎ¹ ÎºÎ±Î¼Î¯Î± ÎºÎ¬ÏÏ„Î± Î±ÎºÏŒÎ¼Î±.</p>
            </div>
        `;
        return;
    }

    // Render saved cards
    container.innerHTML = savedCards.map(card => renderCard(card)).join('');
                <div class="card-icon">${cardIcon}</div>
                <div style="flex: 1;">
                    <div style="display: flex; align-items: center; gap: var(--space-2); margin-bottom: var(--space-1);">
                        <strong style="color: var(--color-text);">${cardBrand}</strong>
                        <span style="color: var(--color-text-muted);">â€¢â€¢â€¢â€¢ ${card.lastFour}</span>
                    </div>
                    <div style="color: var(--color-text-dim); font-size: var(--font-size-sm);">
                        ${card.holderName} â€¢ Î›Î®Î³ÎµÎ¹ ${card.expiry}
                    </div>
                </div>
                ${
        card.isDefault ? `
                    <span class="tag" style="background: rgba(59, 130, 246, 0.15); color: var(--color-primary-light);">
                        â­ Î ÏÎ¿ÎµÏ€Î¹Î»ÎµÎ³Î¼Î­Î½Î·
                    </span>
                ` : `
                    <button class="set-default-btn btn btn-secondary" data-card-id="${card.id}"
                        style="padding: var(--space-2) var(--space-3); font-size: var(--font-size-sm); white-space: nowrap;">
                        ÎŸÏÎ¹ÏƒÎ¼ÏŒÏ‚ Ï€ÏÎ¿ÎµÏ€Î¹Î»ÎµÎ³Î¼Î­Î½Î·Ï‚
                    </button>
                `}
    <button class="remove-card-btn" data-card-id="${card.id}"
        style="background: none; border: none; color: var(--color-text-muted); cursor: pointer; padding: var(--space-2); font-size: 20px; transition: color var(--transition-fast);"
        title="Î‘Ï†Î±Î¯ÏÎµÏƒÎ· ÎºÎ¬ÏÏ„Î±Ï‚">
        ğŸ—‘ï¸
    </button>
            </div >
        </div >
        `;
}

/**
 * Get card brand from number
 */
function getCardBrand(number) {
    const firstDigit = number.charAt(0);
    if (firstDigit === '4') return 'Visa';
    if (firstDigit === '5') return 'Mastercard';
    if (firstDigit === '3') return 'American Express';
    return 'ÎšÎ¬ÏÏ„Î±';
}

/**
 * Initialize add card form
 */
function initAddCardForm() {
    const addCardBtn = document.getElementById('add-card-btn');
    const formContainer = document.getElementById('add-card-form-container');
    const cancelBtn = document.getElementById('cancel-add-card');
    const form = document.getElementById('add-card-form');

    if (!addCardBtn || !formContainer || !form) return;

    // Show form
    addCardBtn.addEventListener('click', function () {
        formContainer.style.display = 'block';
        addCardBtn.style.display = 'none';
    });

    // Hide form
    cancelBtn.addEventListener('click', function () {
        formContainer.style.display = 'none';
        addCardBtn.style.display = 'flex';
        form.reset();
        clearFormErrors('add-card-form');
    });

    // Format card number input
    const cardNumberInput = document.getElementById('card-number');
    cardNumberInput.addEventListener('input', function (e) {
        let value = e.target.value.replace(/\s/g, '');
        let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
        e.target.value = formattedValue;
    });

    // Format expiry input
    const expiryInput = document.getElementById('card-expiry');
    expiryInput.addEventListener('input', function (e) {
        let value = e.target.value.replace(/\D/g, '');
        if (value.length >= 2) {
            value = value.substring(0, 2) + '/' + value.substring(2, 4);
        }
        e.target.value = value;
    });

    // Only allow numbers for CVV
    const cvvInput = document.getElementById('card-cvv');
    cvvInput.addEventListener('input', function (e) {
        e.target.value = e.target.value.replace(/\D/g, '');
    });

    // Handle form submission
    form.addEventListener('submit', function (e) {
        e.preventDefault();
        handleAddCard();
    });
}

/**
 * Handle add card submission
 */
function handleAddCard() {
    const cardNumber = document.getElementById('card-number').value.replace(/\s/g, '');
    const holderName = document.getElementById('card-holder').value.trim();
    const expiry = document.getElementById('card-expiry').value;
    const cvv = document.getElementById('card-cvv').value;

    // Clear previous errors
    clearFormErrors('add-card-form');

    // Validation
    if (cardNumber.length < 15 || cardNumber.length > 16) {
        showFieldError('card-number', 'ÎœÎ· Î­Î³ÎºÏ…ÏÎ¿Ï‚ Î±ÏÎ¹Î¸Î¼ÏŒÏ‚ ÎºÎ¬ÏÏ„Î±Ï‚');
        return;
    }

    if (!holderName) {
        showFieldError('card-holder', 'Î•Î¹ÏƒÎ¬Î³ÎµÏ„Îµ Ï„Î¿ ÏŒÎ½Î¿Î¼Î± ÎºÎ±Ï„ÏŒÏ‡Î¿Ï…');
        return;
    }

    if (!/^\d{2}\/\d{2}$/.test(expiry)) {
        showFieldError('card-expiry', 'ÎœÎ· Î­Î³ÎºÏ…ÏÎ· Î·Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î± (MM/YY)');
        return;
    }

    if (cvv.length < 3 || cvv.length > 4) {
        showFieldError('card-cvv', 'ÎœÎ· Î­Î³ÎºÏ…ÏÎ¿Ï‚ CVV');
        return;
    }

    // Create card object
    const newCard = {
        id: Date.now().toString(),
        number: cardNumber,
        lastFour: cardNumber.slice(-4),
        holderName: holderName.toUpperCase(),
        expiry: expiry,
        isDefault: getStoredCards().length === 0 // First card is default
    };

    // Save card
    saveCard(newCard);

    // Show success message
    showNotification('Î— ÎºÎ¬ÏÏ„Î± Ï€ÏÎ¿ÏƒÏ„Î­Î¸Î·ÎºÎµ Î¼Îµ ÎµÏ€Î¹Ï„Ï…Ï‡Î¯Î±!', 'success');

    // Reset form and reload cards
    document.getElementById('add-card-form').reset();
    document.getElementById('add-card-form-container').style.display = 'none';
    document.getElementById('add-card-btn').style.display = 'flex';
    loadSavedCards();
}

/**
 * Get stored cards from localStorage
 */
function getStoredCards() {
    const cards = localStorage.getItem('payment_cards');
    return cards ? JSON.parse(cards) : [];
}

/**
 * Save card to localStorage
 */
function saveCard(card) {
    const cards = getStoredCards();
    cards.push(card);
    localStorage.setItem('payment_cards', JSON.stringify(cards));
}

/**
 * Remove card from localStorage
 */
function removeCard(cardId) {
    if (!confirm('Î•Î¯ÏƒÏ„Îµ ÏƒÎ¯Î³Î¿Ï…ÏÎ¿Î¹ ÏŒÏ„Î¹ Î¸Î­Î»ÎµÏ„Îµ Î½Î± Î±Ï†Î±Î¹ÏÎ­ÏƒÎµÏ„Îµ Î±Ï…Ï„Î® Ï„Î·Î½ ÎºÎ¬ÏÏ„Î±;')) {
        return;
    }

    let cards = getStoredCards();
    const cardToRemove = cards.find(card => card.id === cardId);

    if (!cardToRemove) return;

    // Filter out the card to remove
    cards = cards.filter(card => card.id !== cardId);

    // If we removed the default card and there are other cards left, make the first one default
    if (cardToRemove.isDefault && cards.length > 0) {
        cards[0].isDefault = true;
    }

    // Save updated cards
    localStorage.setItem('payment_cards', JSON.stringify(cards));

    showNotification('Î— ÎºÎ¬ÏÏ„Î± Î±Ï†Î±Î¹ÏÎ­Î¸Î·ÎºÎµ Î¼Îµ ÎµÏ€Î¹Ï„Ï…Ï‡Î¯Î±', 'success');
    loadSavedCards();
}

/**
 * Set a card as default
 */
function setDefaultCard(cardId) {
    const cards = getStoredCards();

    // Update all cards: set the selected one as default, others as non-default
    const updatedCards = cards.map(card => ({
        ...card,
        isDefault: card.id === cardId
    }));

    localStorage.setItem('payment_cards', JSON.stringify(updatedCards));
    showNotification('Î— Ï€ÏÎ¿ÎµÏ€Î¹Î»ÎµÎ³Î¼Î­Î½Î· ÎºÎ¬ÏÏ„Î± ÎµÎ½Î·Î¼ÎµÏÏÎ¸Î·ÎºÎµ!', 'success');
    loadSavedCards();
}

/**
 * Show field error
 */
function showFieldError(fieldId, message) {
    const field = document.getElementById(fieldId);
    if (!field) return;

    const formGroup = field.closest('.form-group');
    const errorDiv = formGroup.querySelector('.form-error');

    formGroup.classList.add('error');
    if (errorDiv) {
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
    }
}

/**
 * Clear form errors
 */
function clearFormErrors(formId) {
    const form = document.getElementById(formId);
    if (!form) return;

    form.querySelectorAll('.form-group').forEach(group => {
        group.classList.remove('error');
        const errorDiv = group.querySelector('.form-error');
        if (errorDiv) {
            errorDiv.textContent = '';
            errorDiv.style.display = 'none';
        }
    });
}
